{% extends 'base.html' %}
{% load static %}
{% block title %}Boxes{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/boxes.css' %}">
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="titulo-content">
        <h1>Boxes</h1>

        <div class="filtros-container">
            <div class="filtros-superiores">
                <div class="card-disponibles">
                    <div class="card-titulo">Total Boxes Disponibles</div>
                    <div class="card-numero" id="total-disponibles">{{ total_disponibles }}</div>
                </div>

                <div class="leyenda-boxes">
                    <div><span class="color-circulo gray"></span>Disponible</div>
                    <div><span class="color-circulo red"></span>En uso</div>
                    <div><span class="color-circulo yellow"></span>En Mantención</div>
                </div>
            </div>

            <div class="filtros-inferiores">
                <div class="filtrar-wrapper">
                    <button class="filtrar-btn" onclick="toggleFiltro()">
                        <span id="boxes-seleccionados-text">Filtrar por estado</span> ▼
                    </button>
                    <div class="dropdown-filtro hidden">
                        <div onclick="filtrarBoxes('Disponible')">Disponibles</div>
                        <div onclick="filtrarBoxes('Ocupado')">En Uso</div>
                        <div onclick="filtrarBoxes('En mantención')">En Mantención</div>
                        <div onclick="filtrarBoxes('Todos')">Mostrar Todos</div>
                    </div>
                </div>

                <div class="filtrar-wrapper">
                    <button class="filtrar-btn" onclick="togglePasillosFiltro()">
                        <span id="pasillos-seleccionados-text">Filtrar por pasillo</span> ▼
                    </button>
                    <div class="dropdown-filtro pasillos-dropdown hidden">
                        <div class="checkbox-item">
                            <input type="checkbox" id="todos-pasillos" checked onclick="toggleTodosPasillos(this)">
                            <label for="todos-pasillos">Todos los pasillos</label>
                        </div>
                        {% for item in pasillos_data %}
                        <div class="checkbox-item">
                            <input type="checkbox" name="pasillo" value="{{ item.pasillo.idpasillo }}"
                                class="pasillo-checkbox" checked onclick="actualizarSeleccionPasillos()">
                            <label>{{ item.pasillo.nombrepasillo }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="pasillos-container">
        {% for item in pasillos_data %}
        <div class="pasillo" data-pasillo-id="{{ item.pasillo.idpasillo }}">
            <div class="pasillo-header" onclick="toggleBoxes(this)">
                {{ item.pasillo.nombrepasillo }} - Boxes Disponibles: {{ item.disponibles }} ▼
            </div>

            <div class="boxes">
                {% for box_data in item.boxes_data %}
                <a href="{% url 'box_detail' box_data.box.idbox %}" style="text-decoration: none;">
                    <div class="box" data-box-id="{{ box_data.box.idbox }}">
                        <div class="box-number">Box {{ box_data.box.numerobox }}</div>
                        <div class="status-indicator 
                        {% if box_data.estado == 'disponible' %} gray
                        {% elif box_data.estado == 'ocupado' %} red
                        {% elif box_data.estado == 'mantencion' %} yellow
                        {% else %} purple
                        {% endif %}" data-estado="{{ box_data.estado }}">
                        </div>
                    </div>
                </a>
                {% empty %}
                <p>No hay boxes en este pasillo.</p>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function togglePasillosFiltro() {
        const dropdown = document.querySelector('.pasillos-dropdown');
        dropdown.classList.toggle('hidden');

        document.querySelectorAll('.dropdown-filtro:not(.pasillos-dropdown)').forEach(d => {
            d.classList.add('hidden');
        });
    }

    function toggleTodosPasillos(checkbox) {
        const pasillosCheckboxes = document.querySelectorAll('.pasillo-checkbox');
        const todosChecked = checkbox.checked;

        pasillosCheckboxes.forEach(cb => {
            cb.checked = todosChecked;
        });

        actualizarSeleccionPasillos();
    }

    function actualizarSeleccionPasillos() {
        const pasillosCheckboxes = document.querySelectorAll('.pasillo-checkbox:checked');
        const todosCheckbox = document.getElementById('todos-pasillos');
        const pasillosSeleccionadosText = document.getElementById('pasillos-seleccionados-text');

        const allChecked = pasillosCheckboxes.length === document.querySelectorAll('.pasillo-checkbox').length;
        todosCheckbox.checked = allChecked;

        if (allChecked || pasillosCheckboxes.length === 0) {
            pasillosSeleccionadosText.textContent = 'Todos los pasillos';
        } else if (pasillosCheckboxes.length === 1) {
            pasillosSeleccionadosText.textContent = pasillosCheckboxes[0].nextElementSibling.textContent;
        } else {
            pasillosSeleccionadosText.textContent = `${pasillosCheckboxes.length} pasillos seleccionados`;
        }

        filtrarPorPasillos();
    }

    function filtrarPorPasillos() {
        const pasillosCheckboxes = document.querySelectorAll('.pasillo-checkbox:checked');
        const pasillosContainer = document.querySelector('.pasillos-container');
        const pasillos = pasillosContainer.querySelectorAll('.pasillo');

        if (pasillosCheckboxes.length === 0 || document.getElementById('todos-pasillos').checked) {
            pasillos.forEach(pasillo => {
                pasillo.style.display = 'block';
            });
            return;
        }

        const selectedIds = Array.from(pasillosCheckboxes).map(cb => cb.value);

        pasillos.forEach(pasillo => {
            const pasilloId = pasillo.getAttribute('data-pasillo-id');
            pasillo.style.display = selectedIds.includes(pasilloId) ? 'block' : 'none';
        });
    }

    function toggleFiltro() {
        const dropdown = document.querySelector('.dropdown-filtro:not(.pasillos-dropdown)');
        dropdown.classList.toggle('hidden');

        document.querySelector('.pasillos-dropdown').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', function () {
        actualizarSeleccionPasillos();
    });

    function toggleBoxes(header) {
        const boxes = header.nextElementSibling;
        boxes.classList.toggle('hidden');
        header.textContent = header.textContent.includes('▲')
            ? header.textContent.replace('▲', '▼')
            : header.textContent.replace('▼', '▲');
    }

    function toggleFiltro() {
        const dropdown = document.querySelector('.dropdown-filtro');
        dropdown.classList.toggle('hidden');
    }

    function filtrarBoxes(filtro) {
        const boxes = document.querySelectorAll('.box');

        boxes.forEach(box => {
            const statusIndicator = box.querySelector('.status-indicator');
            const classes = statusIndicator.classList;
            const visible = (
                (filtro === 'Disponible' && classes.contains('gray')) ||
                (filtro === 'Ocupado' && classes.contains('red')) ||
                (filtro === 'En mantención' && classes.contains('yellow')) ||
                (filtro === 'Todos')
            );

            box.closest('a').style.display = visible ? 'block' : 'none';
        });

        toggleFiltro();
    }

    function actualizarEstadoBoxes(pasillos) {
        console.log('Iniciando actualización de estados...');
        let totalDisponibles = 0;

        pasillos.forEach(pasilloData => {
            const boxes = pasilloData.boxes;

            boxes.forEach(box => {
                const boxElement = document.querySelector(`div[data-box-id="${box.id}"]`);

                if (boxElement) {
                    const statusIndicator = boxElement.querySelector('.status-indicator');
                    if (statusIndicator) {
                        console.log(`Actualizando box ${box.id} a estado ${box.estado}`);

                        statusIndicator.classList.remove('gray', 'red', 'yellow', 'purple');

                        switch (box.estado) {
                            case 'disponible':
                                statusIndicator.classList.add('gray');
                                totalDisponibles++;
                                break;
                            case 'ocupado':
                                statusIndicator.classList.add('red');
                                break;
                            case 'mantencion':
                                statusIndicator.classList.add('yellow');
                                break;
                            default:
                                statusIndicator.classList.add('purple');
                        }

                        void statusIndicator.offsetWidth;
                    }
                } else {
                    console.log(`Box element ${box.id} no encontrado`);
                }
            });
        });

        const totalElement = document.getElementById('total-disponibles');
        if (totalElement) {
            totalElement.textContent = totalDisponibles;
        }
    }

    function connectWebSocket() {
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(
            `${ws_scheme}://${window.location.host}/ws/estado-boxes/`
        );

        socket.onopen = function (e) {
            console.log("WebSocket conectado correctamente");
        };

        socket.onmessage = function (e) {
            try {
                const data = JSON.parse(e.data);
                console.log('Datos recibidos:', data);
                if (data.type === 'estado_boxes') {
                    requestAnimationFrame(() => {
                        actualizarEstadoBoxes(data.pasillos);
                    });
                }
            } catch (error) {
                console.error('Error procesando mensaje:', error);
            }
        };

        socket.onclose = function (e) {
            console.log('WebSocket desconectado, reconectando en 5 segundos...');
            setTimeout(connectWebSocket, 5000);
        };

        return socket;
    }

    document.addEventListener('DOMContentLoaded', connectWebSocket);
</script>
{% endblock %}