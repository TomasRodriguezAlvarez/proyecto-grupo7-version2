{% extends 'base.html' %}
{% load static %}
{% block title %}Espacios{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/espacios.css' %}">
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="titulo-content">
        <h1>Espacios</h1>

        <div class="filtros-container">
            <div class="filtros-superiores">
                <div class="card-disponibles">
                    <div class="card-titulo">Total Espacios Disponibles</div>
                    <div class="card-numero" id="total-disponibles">{{ total_disponibles }}</div>
                </div>

                <div class="leyenda-espacios">
                    <div><span class="color-circulo gray"></span>Disponible</div>
                    <div><span class="color-circulo red"></span>En uso</div>
                    <div><span class="color-circulo yellow"></span>En Mantención</div>
                </div>
            </div>

            <div class="filtros-inferiores">
                <div class="filtrar-wrapper">
                    <button class="filtrar-btn" onclick="toggleFiltro()">
                        <span id="espacios-seleccionados-text">Filtrar por estado</span> ▼
                    </button>
                    <div class="dropdown-filtro hidden">
                        <div onclick="filtrarEspacios('Disponible')">Disponibles</div>
                        <div onclick="filtrarEspacios('Ocupado')">En Uso</div>
                        <div onclick="filtrarEspacios('En mantención')">En Mantención</div>
                        <div onclick="filtrarEspacios('Todos')">Mostrar Todos</div>
                    </div>
                </div>

                <div class="filtrar-wrapper">
                    <button class="filtrar-btn" onclick="toggleZonasFiltro()">
                        <span id="zonas-seleccionadas-text">Filtrar por zona</span> ▼
                    </button>
                    <div class="dropdown-filtro zonas-dropdown hidden">
                        <div class="checkbox-item">
                            <input type="checkbox" id="todas-zonas" checked onclick="toggleTodasZonas(this)">
                            <label for="todas-zonas">Todas las zonas</label>
                        </div>
                        {% for item in zonas_data %}
                        <div class="checkbox-item">
                            <input type="checkbox" class="zona-checkbox" id="zona-{{ item.zona.idzona }}" 
                                   data-zona="{{ item.zona.idzona }}" checked onclick="filtrarPorZona()">
                            <label for="zona-{{ item.zona.idzona }}">{{ item.zona.nombrezona }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="espacios-container">
            {% for item in zonas_data %}
            <div class="zona-section" data-zona="{{ item.zona.idzona }}">
                <div class="zona-header">
                    <h2>{{ item.zona.nombrezona }}</h2>
                    <span class="disponibles-count">{{ item.disponibles }} disponibles</span>
                </div>

                <div class="espacios-grid">
                    {% for espacio_item in item.espacios_data %}
                    <div class="espacio-card {{ espacio_item.estado }}" 
                         data-estado="{{ espacio_item.estado }}" 
                         data-zona="{{ item.zona.idzona }}"
                         onclick="irAEspacio({{ espacio_item.espacio.idespacio }})">
                        <div class="espacio-numero">{{ espacio_item.espacio.numeroespacio }}</div>
                        <div class="espacio-info">
                            <div class="tipo-actividad">{{ espacio_item.espacio.tipoactividadespacio|default:"Sin asignar" }}</div>
                            <div class="estado-text">
                                {% if espacio_item.estado == 'disponible' %}
                                    Disponible
                                {% elif espacio_item.estado == 'ocupado' %}
                                    En uso
                                {% elif espacio_item.estado == 'mantencion' %}
                                    En mantención
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function toggleFiltro() {
    const dropdown = document.querySelector('.dropdown-filtro');
    dropdown.classList.toggle('hidden');
}

function filtrarEspacios(estado) {
    const espacios = document.querySelectorAll('.espacio-card');
    const textoBtn = document.getElementById('espacios-seleccionados-text');
    
    espacios.forEach(espacio => {
        if (estado === 'Todos') {
            espacio.style.display = 'block';
        } else {
            const estadoEspacio = espacio.getAttribute('data-estado');
            if (estado === 'Disponible' && estadoEspacio === 'disponible') {
                espacio.style.display = 'block';
            } else if (estado === 'Ocupado' && estadoEspacio === 'ocupado') {
                espacio.style.display = 'block';
            } else if (estado === 'En mantención' && estadoEspacio === 'mantencion') {
                espacio.style.display = 'block';
            } else {
                espacio.style.display = 'none';
            }
        }
    });
    
    textoBtn.textContent = estado === 'Todos' ? 'Filtrar por estado' : `Estado: ${estado}`;
    document.querySelector('.dropdown-filtro').classList.add('hidden');
    actualizarContadores();
}

function toggleZonasFiltro() {
    const dropdown = document.querySelector('.zonas-dropdown');
    dropdown.classList.toggle('hidden');
}

function toggleTodasZonas(checkbox) {
    const zonaCheckboxes = document.querySelectorAll('.zona-checkbox');
    zonaCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    filtrarPorZona();
}

function filtrarPorZona() {
    const zonasChecked = Array.from(document.querySelectorAll('.zona-checkbox:checked')).map(cb => cb.getAttribute('data-zona'));
    const zonaSections = document.querySelectorAll('.zona-section');
    const textoBtn = document.getElementById('zonas-seleccionadas-text');
    
    zonaSections.forEach(section => {
        const zonaId = section.getAttribute('data-zona');
        if (zonasChecked.includes(zonaId)) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    });
    
    const todosCheckbox = document.getElementById('todas-zonas');
    const totalCheckboxes = document.querySelectorAll('.zona-checkbox').length;
    const checkedCheckboxes = zonasChecked.length;
    
    if (checkedCheckboxes === totalCheckboxes) {
        textoBtn.textContent = 'Filtrar por zona';
        todosCheckbox.checked = true;
    } else if (checkedCheckboxes === 0) {
        textoBtn.textContent = 'Ninguna zona seleccionada';
        todosCheckbox.checked = false;
    } else {
        textoBtn.textContent = `${checkedCheckboxes} zonas seleccionadas`;
        todosCheckbox.checked = false;
    }
    
    actualizarContadores();
}

function actualizarContadores() {
    let totalDisponibles = 0;
    const zonasVisibles = document.querySelectorAll('.zona-section[style*="block"], .zona-section:not([style*="none"])');
    
    zonasVisibles.forEach(zona => {
        const espaciosDisponibles = zona.querySelectorAll('.espacio-card.disponible[style*="block"], .espacio-card.disponible:not([style*="none"])');
        totalDisponibles += espaciosDisponibles.length;
    });
    
    document.getElementById('total-disponibles').textContent = totalDisponibles;
}

function irAEspacio(espacioId) {
    window.location.href = `/espacio/${espacioId}/`;
}

// Cerrar dropdowns al hacer clic fuera
document.addEventListener('click', function(event) {
    if (!event.target.closest('.filtrar-wrapper')) {
        document.querySelectorAll('.dropdown-filtro').forEach(dropdown => {
            dropdown.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}
